<html>
<head>
<title>..::| Le Concert d'à Côté |::..</title>
<meta name="viewport" content="initial-scale=1.0, user-scalable=no" />
<link rel="stylesheet" type="text/css" href="css/style.css" media="screen" />


<link rel="stylesheet" href="css/slider.css" />
<script src="http://code.jquery.com/jquery-1.9.1.js"></script>
<script src="http://code.jquery.com/ui/1.10.2/jquery-ui.js"></script>

<script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jquery/1.3.0/jquery.min.js"></script>
<script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jqueryui/1.8.15/jquery-ui.min.js"></script>
<script type="text/javascript" src="http://maps.google.com/maps/api/js?sensor=true"></script>
<script type="text/javascript">
	$(document).ready(function() {
		//Init Geocoder
		var geocoder = new google.maps.Geocoder();
		//Autocomplete
		$('input#address').autocomplete({
			source : function(request, response) {
				geocoder.geocode({
					'address' : $('input#address').val()
				}, function(results, status) {
					response($.map(results, function(item) {
						return {
							value : item.formatted_address
						}
					}));
				});
			},
			select : function(event, ui) {
				$('input#address').val(ui.item['value']);
			},
			minLength : 2
		});
	});

	function initialiser() {
		var latlng = new google.maps.LatLng(48.856614, 2.3522219);
		//objet contenant des propriétés avec des identificateurs prédéfinis dans Google Maps permettant
		//de définir des options d'affichage de notre carte
		var options = {
			center : latlng,
			zoom : 12,
			mapTypeId : google.maps.MapTypeId.ROADMAP
		};
		//constructeur de la carte qui prend en paramêtre le conteneur HTML
		//dans lequel la carte doit s'afficher et les options
		carte = new google.maps.Map(document.getElementById("carte"), options);
	}

	/*
	 * GeoLocalization
	 */
	function geoLocate() {
		if (navigator.geolocation)
			var watchId = navigator.geolocation.watchPosition(successCallback, null, { enableHighAccuracy : true});
		else
			alert("Votre navigateur ne prend pas en compte la géolocalisation HTML5");
	}

	function successCallback(position) {
		lat = position.coords.latitude;
		lng = position.coords.longitude;		
		reverseGeocoding(lat, lng);
		setUserLocation(lat, lng);
	}
	
	function setUserLocation(lat, lng) {
		carte.panTo(new google.maps.LatLng(lat, lng));
		var marker = new google.maps.Marker({
			position : new google.maps.LatLng(lat, lng),
			map : carte
		});
		setOverlay(lat, lng);
	}

	/*
	 * Reverse geocoding
	 */
	function reverseGeocoding(lat, lng) {
		var geocoder = new google.maps.Geocoder();
		var point = new google.maps.LatLng(parseFloat(lat), parseFloat(lng));
		geocoder.geocode({"latLng" : point },
				function(data, status) {
					if (status == google.maps.GeocoderStatus.OK && data[0]) {
						document.getElementById("address").value = data[0].formatted_address;
					} else {
						alert("Erreur: " + status);
					}
				});
		return false;
	}
	
	
	/*
	 * Geocoding
	 */
	function geoCodeAddress(obj) {
		var geocoder = new google.maps.Geocoder();
		if (obj != '') {
			geocoder.geocode({ "address" : obj }, function(results, status) {
				if (status == google.maps.GeocoderStatus.OK) {
					var latlng = results[0].geometry.location + "";
					var tab_latlng = latlng.split(',');
					var latitude = tab_latlng[0].replace('(', '');
					var longitude = tab_latlng[1].replace(')', '');
					setUserLocation(latitude, longitude);
				} else {
					alert("Aucune Adresse de ce type n'existe");
				}
			});
		}
	}
	
	//c'est ma fonction qui actualise la maps a chaque fois qu'on click dessus !
	//pour tester mettez bien des cordonnées qui son en france!!!
	function setOverlay(lat, lng) {	
		$.ajax({
			type : 'GET',
			url : '/concert?lat=' + parseFloat(lat) + '&long='
					+ parseFloat(lng) + '&rayon='
					+ parseFloat(rayon),
			dataType : 'json',
			contentType : 'application/json',
			success : function(response) {
				var latlng = new google.maps.LatLng(parseFloat(lat), parseFloat(lng));
				//objet contenant des propriétés avec des identificateurs prédéfinis dans Google Maps permettant
				//de définir des options d'affichage de notre carte
				var options = {
					center : latlng,
					zoom : 12,
					mapTypeId : google.maps.MapTypeId.ROADMAP
				};
				//constructeur de la carte qui prend en paramêtre le conteneur HTML
				//dans lequel la carte doit s'afficher et les options
				carte = new google.maps.Map(document.getElementById("carte"),
						options);
				var pinColor = "#79CDCD";
				var pinImage = new google.maps.MarkerImage(
						"http://chart.apis.google.com/chart?chst=d_map_pin_letter&chld=%E2%80%A2|"
								+ pinColor, new google.maps.Size(21, 34),
						new google.maps.Point(0, 0), new google.maps.Point(10,
								34));

				var marqueur = new google.maps.Marker({
					position : new google.maps.LatLng(parseFloat(lat), parseFloat(lng)),
					map : carte,
					title : "Vous etes ici",
					icon : pinImage
				});

				var myWindowOptions = {
					content : '<h3>Vous etes ici</h3>'
				};

				var myInfoWindow = new google.maps.InfoWindow(myWindowOptions);
				google.maps.event.addListener(marqueur, 'click', function() {
					myInfoWindow.open(carte, marqueur);
				});
				for ( var i = 0; i < response.length; i++) {
					var lemarqueur = new google.maps.Marker({
						position : new google.maps.LatLng(
								parseFloat(response[i].latlong[0]),
								parseFloat(response[i].latlong[1])),
						map : carte,
						title : response[i].title
					});
					var WindowOptions = {
						content : '<h3>' + response[i].title + ' No ' + i
								+ '</h3>'
					};
					var InfoWindow = new google.maps.InfoWindow(WindowOptions);
					google.maps.event.addListener(lemarqueur, 'click',
							function() {
								InfoWindow.open(carte, lemarqueur);
							});
				}
				;
			}
		});
	}
	

	
	$(function() {
	$( "#rayon" ).slider({
		range: false,
		min: 1,
		max: 200,
		values: [50],
		slide: function( event, ui ) {
			$( "#amount" ).val(ui.values[0] + " Km");
			}
			});
	$( "#amount" ).val($( "#rayon" ).slider( "values", 0 ) + " Km");
		rayon = $("#rayon").slider("values", 0);
	});
	
</script>

</head>

<body onload="initialiser()">

	<table style="width: 100%;">
		<tr>
			<td align="left"><a href="index.html"><img src="images/logo.png" style="width: 200px; height: 90px;"></a></td>
			<td>
			    <form class="form-wrapper cf" id="myForm" onsubmit="geoCodeAddress(this.address.value); return false;">
				<span class="form-wraper-img"><img src="images/marker.png" onclick="geoLocate()" style="width: 32px; height: 32px; padding-top: 4px;" /></span>
				<input id="address" name="address" type="text" class="form-wrapper-input" placeholder="Saisir une adresse..." required />
				<button id="valider" type="submit">Cherche</button>				
				<input type="text" id="amount" class="form-wraper-amount"/>
				<!-- <span class="form-wrapper-amount-before"></span> -->
				<div id="rayon" class="form-wraper-range"></div>
			    </form>
			    
			</td>
		</tr>
	</table>
	<div id="carte"></div>
	<div id="content"></div>
</body>
</html>