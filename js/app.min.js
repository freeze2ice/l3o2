function newGoogleMap(e,t){var n=new google.maps.LatLng(e,t);var r={center:n,zoom:11,mapTypeId:google.maps.MapTypeId.ROADMAP};carte=new google.maps.Map(document.getElementById("carte"),r)}function initialiser(){var e=QueryString.address,t=parseFloat(QueryString.range),n="";if(exists(QueryString.artist)){n=QueryString.artist.replace("%20"," ")}$.ajax({type:"GET",dataType:"json",url:"http://freegeoip.net/json/",timeout:200,error:function(e,t,n){ip_latitude=48.8588589;ip_longitude=2.3470599;newGoogleMap(ip_latitude,ip_longitude)},success:function(e){ip_latitude=e.latitude;ip_longitude=e.longitude;newGoogleMap(ip_latitude,ip_longitude)}});if(e&&t){update_params(e,t,n);geoCodeAddress(e,t,n)}}function geoLocate(){if(navigator.geolocation)navigator.geolocation.getCurrentPosition(successCallback);else alert("Your browser does not support HTML5 Geolocation!")}function successCallback(e){var t=e.coords.latitude,n=e.coords.longitude,r=parseFloat($("#range").slider("value")),i=document.getElementById("artist").value;reverseGeocoding(t,n,r,i);setUserLocation(t,n,r,i)}function setUserLocation(e,t,n,r){carte.panTo(new google.maps.LatLng(e,t));var i=new google.maps.Marker({position:new google.maps.LatLng(e,t),map:carte});getConcerts(e,t,n,r)}function reverseGeocoding(e,t,n,r){var i=new google.maps.Geocoder;var s=new google.maps.LatLng(parseFloat(e),parseFloat(t));i.geocode({latLng:s},function(e,t){if(t==google.maps.GeocoderStatus.OK&&e[0]){document.getElementById("address").value=e[0].formatted_address;update_url(e[0].formatted_address,n,r)}else{alert("Error: "+t)}});return false}function geoCodeAddress(e,t,n){var e=document.getElementById("address").value,t=parseFloat($("#range").slider("value")),n=document.getElementById("artist").value;var r=new google.maps.Geocoder;if(e!=""){r.geocode({address:e},function(r,i){if(i==google.maps.GeocoderStatus.OK){var s=r[0].geometry.location+"",o=s.split(","),u=o[0].replace("(",""),a=o[1].replace(")","");u=parseFloat(u);a=parseFloat(a);t=parseFloat(t);update_url(e,t,n);setUserLocation(u,a,t,n)}else alert("No such address exists!")})}}function closeInfoWindows(){var e=infoWindows.length;while(e--){infoWindows[e].close()}}function newPoint(e,t,n){var r=encodeURIComponent(document.URL+t.artist);var i="http://userserve-ak.last.fm/serve/252/"+t["_id"]+".jpg";summary=t.artist+" - "+t.startDate+" - "+t.address.name+", "+t.address.street+", "+t.address.postalcode+", "+t.address.city+", "+t.address.country,fb_share='<a href="https://www.facebook.com/sharer/sharer.php?s=100&p[url]='+r+"&p[title]="+t.title+"&p[summary]="+summary+"&p[images][0]="+i+'" target="_blank"><img width="25" src="images/fb_1.png" alt"=Share On Facebook title="Share On Facebook"/></a>',tw_share='<a href="https://twitter.com/share?url='+r+"&text="+t.title+"+"+t.artist+"&via=ConcertDaCote&related=concertdacote,ConcertDaCote,"+'" target="_blank"><img width="25" src="images/twitter_1.png" alt="Share On Twitter" title="Share On Twitter"/></a>',lastfm='<a target="_blank" href ='+t.url+'><img width="25" src="images/lastfm.png" alt="More Info On Last.fm" title="More Info On Last.fm"/></a>',gplus='<a href="https://plus.google.com/share?url='+r+'" target="_blank"><img width="25" src="images/google_plus.png" alt="Share on G+" title="Share On Google+"/></a>',su='<a href="http://stumbleupon.com/submit?url='+r+'" target="_blank"><img width="25" src="images/stumble_upon.png" alt="Stumble" title="Stumble"/></a>';var s=new google.maps.LatLng(t.latlong[0],t.latlong[1]);var o=new google.maps.Marker({position:s,title:t.title});n.addMarker(o);var u={content:'<table><tr><td><img src="'+t.image+'"/></td><td><div class="info-window-title">'+t.title+'</div><div class="info-window-body"><b>Artists: </b>'+t.artist+"<br><b>Date: </b>"+t.startDate+"<br>"+t.address.name+" "+t.address.street+"<br>"+t.address.postalcode+", "+t.address.city+", "+t.address.country+"</div></td></tr><tr><td></td><td>"+lastfm+"	"+fb_share+"	"+tw_share+"	"+gplus+"	"+su+"</td></tr></table>"};var a=new google.maps.InfoWindow(u);infoWindows.push(a);google.maps.event.addListener(o,"click",function(){closeInfoWindows();a.open(e,o)});return o}function plotOverlay(e,t,n){var r=new google.maps.LatLng(parseFloat(e),parseFloat(t));var i={center:r,zoom:12,mapTypeId:google.maps.MapTypeId.ROADMAP};carte=new google.maps.Map(document.getElementById("carte"),i);var s="#79CDCD";var o=new google.maps.MarkerImage("http://chart.apis.google.com/chart?chst=d_map_pin_letter&chld=%E2%80%A2|"+s,new google.maps.Size(21,34),new google.maps.Point(0,0),new google.maps.Point(10,34));var u=new google.maps.Marker({position:new google.maps.LatLng(parseFloat(e),parseFloat(t)),map:carte,title:"Your Location",icon:o});var a={content:"<h5>Your Location</h5>"};var f=new google.maps.InfoWindow(a);google.maps.event.addListener(u,"click",function(){f.open(carte,u)});var l=new OverlappingMarkerSpiderfier(carte,{keepSpiderfied:true});var c=[];if(n.length!=0){for(var h=0;h<n.length;h++){c.push(newPoint(carte,n[h],l))}var p=new MarkerClusterer(carte,c);p.setMaxZoom(15);p.setGridSize(40);google.maps.event.addDomListener(window,"load",initialiser)}else alert("No conerts found at this time for the given parameters (range/address/artist)")}function getConcerts(e,t,n,r){var i;$.ajax({type:"GET",url:"/concert?lat="+e+"&long="+t+"&range="+n+"&artist="+r,contentType:"application/json; charset=UTF-8",error:function(e,t,n){console.log(JSON.stringify(n)+" "+JSON.stringify(t))},success:function(n,r){if(n&&typeof n==="string"&&n!==null){i=JSON.parse(n);plotOverlay(e,t,i)}else{plotOverlay(e,t,n)}}})}function update_url(e,t,n){window.history.pushState("","","?address="+e+"&range="+t+"&artist="+n)}function update_params(e,t,n){document.getElementById("address").value=decodeURIComponent(e);document.getElementById("artist").value=n;$("#range").slider("value",t)}function exists(e){if(e&&typeof e==="string"&&e!==null){return true}else return false}var QueryString=function(){var e={};var t=window.location.search.substring(1);var n=t.split("&");for(var r=0;r<n.length;r++){var i=n[r].split("=");if(typeof e[i[0]]==="undefined"){e[i[0]]=i[1]}else if(typeof e[i[0]]==="string"){var s=[e[i[0]],i[1]];e[i[0]]=s}else{e[i[0]].push(i[1])}}return e}();var infoWindows=[]